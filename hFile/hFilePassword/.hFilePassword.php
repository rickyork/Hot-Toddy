<?php
  class hFilePassword extends hPlugin { private $hFilePasswordDatabase; public function hConstructor() { $this->hFileAuthorized = false; $this->hFilePassword = false; $this->hFilePasswordDatabase = $this->database('hFile/hFilePassword'); $hasAccess = $this->hFiles->hasPermission($this->hFileId, 'r'); if ($this->hFilePasswordDatabase->hasRequiredPasswords($this->hFileId) && $hasAccess) { $this->setVariables($data); $this->hFilePassword = true;   if (isset($_POST['hFilePassword'])) { $results = $this->hFilePasswordDatabase->getRequiredPasswords(); foreach ($results as $data) { $this->checkPassword($data['hFilePassword']); } if (!$this->hFileAuthorized) { $this->passwordForm(true); } } else { $this->passwordForm(); } } else if ($hasAccess) {   $this->hFileAuthorized = true; } else if (!$hasAccess) {   if ($this->hFilePasswordDatabase->hasOptionalPasswords($this->hFileId)) { if (!$this->isSSLEnabled()) { header('Location: https://'.$this->hServerHost.$this->href($this->hFilePath)); exit; } $this->hFilePassword = true; if (isset($_POST['hFilePassword'])) { $results = $this->hFilePasswordDatabase->getOptionalPasswords($this->hFileId); foreach ($results as $data) { $this->checkPassword($data['hFilePassword']); } if (!$this->hFileAuthorized) { $this->passwordForm(true); } } else { $this->passwordForm(); } } } } private function checkPassword($password) { if (trim($password) === trim($_POST['hFilePassword'])) { $this->hFileAuthorized = true; } } private function passwordForm($invalid = false) { $this->hFileTitle = 'This Document Requires a Password'; $this->hFileDocument = $this->getTemplate( $this->hFilePasswordFormTemplate('Form'), array( 'hFilePasswordFormAction' => $this->hFilePath ) ); } } ?>