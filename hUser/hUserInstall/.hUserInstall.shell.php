<?php
  class hUserInstallShell extends hShell { private $hUserLogin; private $hUserDatabase; private $hContactDatabase; public function hConstructor() { if ($this->shellArgumentExists('--hFrameworkConfiguration', 'hFrameworkConfiguration')) { $path = base64_decode($this->getShellArgumentValue('-c', '--hFrameworkConfiguration')); if (!empty($path) && file_exists($path)) { $obj = unserialize(file_get_contents($path)); $options = (object) ''; foreach ($obj as $key => $value) { $options->$key = $value; } } else { echo "Framework configuration could not be retrieved from: ".$path."\n"; } } echo "Installing default users and groups...\n"; $this->hUserLogin = $this->library('hUser/hUserLogin'); $this->hUserDatabase = $this->database('hUser'); $this->hContactDatabase = $this->database('hContact'); $this->plugin('hUser', false, false, false, false); $this->hContactDatabase->saveAddressBook( array( 'hContactAddressBookName' => 'Website Accounts', 'hPlugin' => 'hUser' ) ); $hUserId = $this->hUserDatabase->save( 0, !empty($options->hFrameworkUsername)? $options->hFrameworkUsername : 'administrator', !empty($options->hFrameworkEmailAddress)? $options->hFrameworkEmailAddress : 'administrator@localhost', !empty($options->hFrameworkPassword)? $options->hFrameworkPassword : 'password' ); $hContactId = $this->hDatabase->selectColumn( 'hContactId', 'hContacts', array( 'hContactAddressBookId' => 1, 'hUserId' => (int) $hUserId ) ); $displayName = 'AdministratorUser'; if (!empty($options->hFrameworkFirstName) && !empty($options->hFrameworkLastName)) { $displayName = trim($options->hFrameworkFirstName).' '.trim($options->hFrameworkLastName); } $this->hContactDatabase->saveContact( array( 'hContactFirstName' => !empty($options->hFrameworkFirstName)? trim($options->hFrameworkFirstName) : 'Administrator', 'hContactLastName' => !empty($options->hFrameworkLastName)? trim($options->hFrameworkLastName) : 'User', 'hContactCompany' => 'Company', 'hContactDisplayName' => $displayName ), 1, $hUserId, $hContactId ); echo "Added user Administrator.\n"; $root = $this->hUserDatabase->save(0, 'root', 'root@localhost', ''); $this->hUserDatabase->saveGroupProperties($root, 1, 1, '', 0); echo "Added group root.\n"; $this->hUserDatabase->addUserToGroup($root, $hUserId); echo "Added user Administrator to group root.\n";                              $groups = array( 'Administrators' => 1, 'Website Administrators' => 1, 'Finder Administrators' => 1, 'Calendar Administrators' => 1, 'User Administrators' => 1, 'Employees' => 0, 'Disabled User Accounts' => 0, 'Contact Administrators' => 1, 'Contact Address Book' => 0 );  foreach ($groups as $group => $elevated) { $this->hUserDatabase->saveGroupProperties( $this->hUserDatabase->save(0, $group, str_replace(' ', '', $group).'@localhost', ''), 1, $elevated, '', 0 ); echo "Created group {$group}.\n"; } } } ?>